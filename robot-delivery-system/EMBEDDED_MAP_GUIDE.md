# 机器人实时地图系统 - 使用说明

## 系统概述

本系统为机器人配送管理平台提供了嵌入式实时地图显示功能，支持两种工作模式：
1. **ROS实时地图模式**: 连接真实ROS系统，显示实际地图和机器人位置
2. **模拟地图模式**: 使用预设语义地图进行演示和测试

## 主要功能特性

### ✅ 已实现功能
- [x] 嵌入式地图显示（集成到主页面）
- [x] ROS/模拟双模式切换
- [x] 地图缩放和平移操作
- [x] 机器人位置实时显示
- [x] 机器人符号尺寸优化（缩小显示）
- [x] 开始追踪自动更新机器人位置
- [x] 点击地图控制机器人移动（模拟模式）
- [x] 状态信息实时显示

### 🎯 核心改进
1. **嵌入式设计**: 地图直接嵌入主页面，无需跳转
2. **追踪优化**: "开始追踪"自动每秒更新机器人位置
3. **符号缩小**: 机器人图标尺寸缩小50%，更适合地图显示
4. **界面紧凑**: 控制按钮和状态信息紧凑布局

## 快速开始

### 1. 启动前端应用
```bash
cd robot-delivery-system
npm run dev
```

### 2. 访问主页面
打开浏览器访问: http://localhost:5173

### 3. 使用嵌入式地图
主页面中的"实时地图"区域已集成地图功能：
- 默认启动模拟模式
- 可切换到ROS模式（需要ROS环境）

## 操作指南

### 模拟地图模式 (推荐测试)
1. 确保模式选择为"模拟"
2. 点击"开始追踪"查看机器人移动
3. 点击地图任意位置让机器人移动
4. 使用鼠标滚轮缩放地图
5. 拖拽地图进行平移

### ROS实时地图模式
1. 启动ROS Bridge服务:
   ```bash
   ./start_ros_bridge.sh
   ```
2. 点击"连接ROS"按钮
3. 点击"获取地图"加载地图数据
4. 点击"开始追踪"实时跟踪机器人位置

## 控制按钮说明

| 按钮 | 功能 | 模式 |
|------|------|------|
| 连接ROS | 连接到ROS Bridge服务器 | ROS |
| 获取地图 | 一次性获取地图数据 | ROS |
| 开始追踪 | 每秒自动更新机器人位置 | 两种模式 |
| 停止追踪 | 停止位置自动更新 | 两种模式 |
| 🎯 居中 | 将视图居中到机器人位置 | 两种模式 |
| ROS/模拟 | 切换工作模式 | - |

## 技术实现细节

### 追踪机制
- **ROS模式**: 订阅 `/tf` 话题，实时监听机器人变换
- **模拟模式**: 本地状态管理，10Hz更新频率
- **追踪控制**: 开始追踪后自动每秒获取位置

### 地图渲染
- **ROS地图**: 占用栅格地图，支持unknown/free/occupied区域
- **模拟地图**: 基于语义位置的矢量地图
- **机器人显示**: 圆形本体+方向箭头，尺寸已优化

### 用户交互
- **鼠标滚轮**: 地图缩放
- **鼠标拖拽**: 地图平移
- **点击移动**: 模拟模式下点击目标位置
- **居中功能**: 自动居中到机器人位置

## 自定义配置

### 修改地图配置
编辑 `src/services/simulatedMap.ts`:
```typescript
export const defaultMapConfig: SimulatedMapConfig = {
  width: 800,          // 地图宽度
  height: 600,         // 地图高度
  resolution: 0.05,    // 分辨率(米/像素)
  // ... 其他配置
}
```

### 修改ROS话题
编辑 `src/services/rosConnection.ts`:
```typescript
// 地图话题
name: '/map',              // 修改地图话题名
// TF话题
name: '/tf',               // 修改TF话题名
// 机器人状态话题
name: '/robot_state',      // 修改状态话题名
```

### 调整机器人尺寸
在各个绘制函数中修改尺寸参数:
```typescript
const robotRadius = 0.15;  // 机器人半径
const arrowLength = 0.2;   // 箭头长度
const arrowWidth = 0.05;   // 箭头宽度
```

## 故障排除

### 常见问题

**Q: 地图显示空白**
A: 检查地图数据是否正确加载，尝试重新获取地图

**Q: 机器人位置不更新**
A: 确认已点击"开始追踪"，检查ROS话题是否正常发布

**Q: ROS连接失败**
A: 确认ROS Bridge服务运行正常，检查端口9090是否开放

**Q: 机器人符号太大/太小**
A: 修改绘制函数中的尺寸参数，重新编译

### 调试信息
- 打开浏览器开发者工具查看控制台日志
- 检查网络标签页确认WebSocket连接状态
- 使用ROS命令验证话题数据：
  ```bash
  ros2 topic list
  ros2 topic echo /map
  ros2 topic echo /tf
  ```

## 文件结构

```
src/
├── components/
│   └── EmbeddedMapViewer.vue    # 嵌入式地图组件
├── services/
│   ├── rosConnection.ts         # ROS连接服务
│   └── simulatedMap.ts          # 模拟地图服务
├── views/
│   └── MainDashboard.vue        # 主页面(集成地图)
└── router/
    └── index.ts                 # 路由配置
```

## 更新日志

### v1.2 (当前版本)
- ✅ 实现嵌入式地图显示
- ✅ 优化机器人符号尺寸
- ✅ 改进追踪机制为自动更新
- ✅ 简化用户界面

### v1.1
- 独立地图页面实现
- 双模式支持
- 基础ROS集成

### v1.0
- 初始版本
- 基础地图显示功能

## 联系支持
如遇到问题或需要功能扩展，请查看项目文档或联系开发团队。
